name: 🐱 Cat Management System - Full CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '22.x'
  POSTGRES_DB: cat_management_test
  POSTGRES_USER: user
  POSTGRES_PASSWORD: password
  DATABASE_URL: "postgresql://user:password@localhost:5432/cat_management_test"

jobs:
  # --------------------------------------------------
  # 1. Code Quality (Lint & Format)
  # --------------------------------------------------
  lint_and_format:
    name: 🧹 Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: 📦 Install all dependencies
        run: npm install --workspaces --include-workspace-root

      - name: 🔍 Run Lint Check (All Workspaces)
        run: npm run lint --workspaces --if-present

      - name: 🎨 Run Format Check (All Workspaces)
        run: npm run format:check --workspaces --if-present

  # --------------------------------------------------
  # 2. Build & Unit Test (Backend & Frontend)
  # --------------------------------------------------
  build_and_test:
    name: �️ Build & Test
    runs-on: ubuntu-latest
    needs: lint_and_format
    strategy:
      matrix:
        workspace: [backend, cat-ui-test]
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: 📦 Install dependencies for ${{ matrix.workspace }}
        run: npm install --workspace=${{ matrix.workspace }}

      - name: 🏗️ Build ${{ matrix.workspace }}
        run: npm run build --workspace=${{ matrix.workspace }}

      - name: 🧪 Run Unit Tests for ${{ matrix.workspace }}
        run: npm run test --workspace=${{ matrix.workspace }} -- --passWithNoTests

  # --------------------------------------------------
  # 3. E2E Test (Backend)
  # --------------------------------------------------
  e2e_test:
    name: 🚀 E2E Tests
    runs-on: ubuntu-latest
    needs: build_and_test
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🟢 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: 📦 Install backend dependencies
        run: npm install --workspace=backend

      - name: 🔄 Run Prisma migrations
        run: npm run db:migrate --workspace=backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: 🧪 Run E2E tests
        run: npm run test:e2e --workspace=backend
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

  # --------------------------------------------------
  # 4. Success Notification
  # --------------------------------------------------
  ci_success:
    name: ✅ CI Passed
    runs-on: ubuntu-latest
    needs: [lint_and_format, build_and_test, e2e_test]
    if: success()
    steps:
      - name: 🎉 Success Message
        run: echo "🎉 All CI checks passed successfully! Ready for review."
