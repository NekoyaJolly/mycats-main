import { PrismaClient } from '@prisma/client';
import * as fs from 'node:fs';
import * as path from 'node:path';
import csv from 'csv-parser';

const prisma = new PrismaClient();

interface BreedData {
  key: string;
  name: string;
}

interface CoatColorData {
  key: string;
  name: string;
}

interface NewPedigreeData {
  pedigreeId: string;
  title: string;
  catName: string;
  catName2: string;
  breedCode: string;
  gender: string;
  eyeColor: string;
  coatColorCode: string;
  birthDate: string;
  breederName: string;
  ownerName: string;
  registrationDate: string;
  brotherCount: string;
  sisterCount: string;
  notes: string;
  notes2: string;
  otherNo: string;
  // Father data - æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
  fatherTitle: string;
  fatherName: string; // FatherName
  fatherCatName2: string; // FatherCatName2
  fatherCoatColor: string;
  fatherEyeColor: string;
  fatherJCU: string;
  fatherOtherCode: string;
  // Mother data - æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
  motherTitle: string;
  motherCatName: string; // MotherCatName
  motherCatName2: string; // MotherCatName2
  motherCoatColor: string;
  motherEyeColor: string;
  motherJCU: string;
  motherOtherCode: string;
  // Grandparents data - æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
  ffTitle: string;
  ffCatName: string; // FFCatName
  ffCatColor: string; // FFCatColor
  ffJCU: string;
  fmTitle: string;
  fmCatName: string; // FMCatName
  fmCatColor: string; // FMCatColor
  fmJCU: string;
  mfTitle: string;
  mfCatName: string; // MFCatName
  mfCatColor: string; // MFCatColor
  mfJCU: string;
  mmTitle: string;
  mmCatName: string; // MMCatName
  mmCatColor: string; // MMCatColor
  mmJCU: string;
  // Great-grandparents data - æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å
  fffTitle: string;
  fffCatName: string; // FFFCatName
  fffCatColor: string; // FFFCatColor
  fffJCU: string;
  ffmTitle: string;
  ffmCatName: string; // FFMCatName
  ffmCatColor: string; // FFMCatColor
  ffmJCU: string;
  fmfTitle: string;
  fmfCatName: string; // FMFCatName
  fmfCatColor: string; // FMFCatColor
  fmfJCU: string;
  fmmTitle: string;
  fmmCatName: string; // FMMCatName
  fmmCatColor: string; // FMMCatColor
  fmmJCU: string;
  mffTitle: string;
  mffCatName: string; // MFFCatName
  mffCatColor: string; // MFFCatColor
  mffJCU: string;
  mfmTitle: string;
  mfmCatName: string; // MFMCatName
  mfmCatColor: string; // MFMCatColor
  mfmJCU: string;
  mmfTitle: string;
  mmfCatName: string; // MMFCatName
  mmfCatColor: string; // MMFCatColor
  mmfJCU: string;
  mmmTitle: string;
  mmmCatName: string; // MMMCatName
  mmmCatColor: string; // MMMCatColor
  mmmJCU: string;
  oldCode: string;
}

/**
 * æ–°ã—ã„CSVæ§‹é€ ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆé–¢æ•°
 *
 * @param csvFileName ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆçœç•¥æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
 * @param options ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³
 */
async function importNewStructureCsvData(
  csvFileName?: string,
  options?: {
    skipBreeds?: boolean;
    skipCoatColors?: boolean;
    skipPedigrees?: boolean;
    batchSize?: number;
  },
) {
  const {
    skipBreeds = false,
    skipCoatColors = false,
    skipPedigrees = false,
    batchSize = 100,
  } = options || {};

  try {
    console.log('ğŸš€ æ–°ã—ã„CSVæ§‹é€ ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¾ã™...');

    // ãƒ–ãƒªãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    if (!skipBreeds) {
      await importBreeds();
    }

    // æ¯›è‰²ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    if (!skipCoatColors) {
      await importCoatColors();
    }

    // è¡€çµ±æ›¸ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    if (!skipPedigrees) {
      await importNewStructurePedigrees(csvFileName, batchSize);
    }

    console.log('âœ… æ–°ã—ã„CSVæ§‹é€ ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
  } catch (error) {
    console.error('âŒ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

async function importBreeds() {
  console.log('ğŸ± çŒ«ç¨®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');

  const breeds: BreedData[] = [];
  const csvPath = path.join(
    __dirname,
    '../../NewPedigree/çŒ«ç¨®ãƒ‡ãƒ¼ã‚¿UTF8Ver.csv',
  );

  return new Promise<void>((resolve, reject) => {
    fs.createReadStream(csvPath)
      .pipe(csv({ headers: ['key', 'name'] }))
      .on('data', (data: BreedData) => {
        if (data.key && data.name && data.key !== 'ã‚­ãƒ¼') {
          breeds.push(data);
        }
      })
      .on('end', async () => {
        try {
          const processedBreedNames = new Set<string>();
          for (const breed of breeds) {
            const code = parseInt(breed.key);
            const trimmedName = breed.name.trim();
            if (
              !isNaN(code) &&
              trimmedName &&
              !processedBreedNames.has(trimmedName)
            ) {
              processedBreedNames.add(trimmedName);
              await prisma.breed.upsert({
                where: { code },
                update: { name: trimmedName },
                create: {
                  code,
                  name: trimmedName,
                },
              });
            }
          }
          console.log(`âœ… ${breeds.length}ç¨®ã®çŒ«ç¨®ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
          resolve();
        } catch (error) {
          reject(error);
        }
      })
      .on('error', reject);
  });
}

async function importCoatColors() {
  console.log('ğŸ¨ æ¯›è‰²ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');

  const colors: CoatColorData[] = [];
  const csvPath = path.join(
    __dirname,
    '../../NewPedigree/è‰²æŸ„ãƒ‡ãƒ¼ã‚¿UTF8Ver.csv',
  );

  return new Promise<void>((resolve, reject) => {
    fs.createReadStream(csvPath)
      .pipe(csv({ headers: ['key', 'name'] }))
      .on('data', (data: CoatColorData) => {
        if (data.key && data.name && data.key !== 'ã‚­ãƒ¼') {
          colors.push(data);
        }
      })
      .on('end', async () => {
        try {
          const processedColorNames = new Set<string>();
          for (const color of colors) {
            const code = parseInt(color.key);
            const trimmedName = color.name.trim();
            if (
              !isNaN(code) &&
              trimmedName &&
              !processedColorNames.has(trimmedName)
            ) {
              processedColorNames.add(trimmedName);
              await prisma.coatColor.upsert({
                where: { code },
                update: { name: trimmedName },
                create: {
                  code,
                  name: trimmedName,
                },
              });
            }
          }
          console.log(`âœ… ${colors.length}ç¨®ã®æ¯›è‰²ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`);
          resolve();
        } catch (error) {
          reject(error);
        }
      })
      .on('error', reject);
  });
}

async function importNewStructurePedigrees(
  csvFileName?: string,
  batchSize: number = 100,
) {
  console.log('ğŸ“œ æ–°ã—ã„æ§‹é€ ã§ã®è¡€çµ±æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...');

  const defaultFileName = 'è¡€çµ±æ›¸ãƒ‡ãƒ¼ã‚¿Renamed_converted.csv';
  const fileName = csvFileName || defaultFileName;
  const csvPath = path.join(__dirname, '../../NewPedigree', fileName);

  // ãƒ•ã‚¡ã‚¤ãƒ«å­˜åœ¨ãƒã‚§ãƒƒã‚¯
  if (!fs.existsSync(csvPath)) {
    throw new Error(`CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${csvPath}`);
  }

  console.log(`ğŸ“ ä½¿ç”¨ãƒ•ã‚¡ã‚¤ãƒ«: ${fileName}`);

  const pedigrees: NewPedigreeData[] = [];

  // æ–°ã—ã„æ§‹é€ ã®CSVãƒ˜ãƒƒãƒ€ãƒ¼å®šç¾©
  const headers = [
    'pedigreeId',
    'title',
    'catName',
    'catName2',
    'breedCode',
    'gender',
    'eyeColor',
    'coatColorCode',
    'birthDate',
    'breederName',
    'ownerName',
    'registrationDate',
    'brotherCount',
    'sisterCount',
    'notes',
    'notes2',
    'otherNo',
    // Father data
    'fatherTitle',
    'fatherName',
    'fatherCatName2',
    'fatherCoatColor',
    'fatherEyeColor',
    'fatherJCU',
    'fatherOtherCode',
    // Mother data
    'motherTitle',
    'motherName',
    'motherCatName2',
    'motherCoatColor',
    'motherEyeColor',
    'motherJCU',
    'motherOtherCode',
    // Grandparents data (simplified)
    'ffTitle',
    'ffCatName',
    'ffJCU',
    'fmTitle',
    'fmCatName',
    'fmJCU',
    'mfTitle',
    'mfCatName',
    'mfJCU',
    'mmTitle',
    'mmCatName',
    'mmJCU',
    // Great-grandparents data (simplified)
    'fffTitle',
    'fffCatName',
    'fffJCU',
    'ffmTitle',
    'ffmCatName',
    'ffmJCU',
    'fmfTitle',
    'fmfCatName',
    'fmfJCU',
    'fmmTitle',
    'fmmCatName',
    'fmmJCU',
    'mffTitle',
    'mffCatName',
    'mffJCU',
    'mfmTitle',
    'mfmCatName',
    'mfmJCU',
    'mmfTitle',
    'mmfCatName',
    'mmfJCU',
    'mmmTitle',
    'mmmCatName',
    'mmmJCU',
    'oldCode',
  ];

  return new Promise<void>((resolve, reject) => {
    let rowCount = 0;

    fs.createReadStream(csvPath)
      .pipe(csv({ headers }))
      .on('data', (data: NewPedigreeData) => {
        rowCount++;
        if (
          rowCount > 1 &&
          data.pedigreeId &&
          data.pedigreeId !== 'PedigreeID'
        ) {
          pedigrees.push(data);
        }
      })
      .on('end', async () => {
        try {
          console.log(`ğŸ“Š å‡¦ç†å¯¾è±¡: ${pedigrees.length}ä»¶ã®è¡€çµ±æ›¸ãƒ‡ãƒ¼ã‚¿`);

          // ãƒãƒƒãƒå‡¦ç†ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          for (let i = 0; i < pedigrees.length; i += batchSize) {
            const batch = pedigrees.slice(i, i + batchSize);
            console.log(
              `ğŸ“¦ ãƒãƒƒãƒ ${Math.floor(i / batchSize) + 1}/${Math.ceil(pedigrees.length / batchSize)} (${batch.length}ä»¶) ã‚’å‡¦ç†ä¸­...`,
            );

            for (const pedigree of batch) {
              try {
                // æ—¥ä»˜ã®è§£æ
                const birthDate = pedigree.birthDate
                  ? parseDate(pedigree.birthDate)
                  : null;
                const registrationDate = pedigree.registrationDate
                  ? parseDate(pedigree.registrationDate)
                  : null;

                // æ•°å€¤ã®è§£æ
                const breedCode = pedigree.breedCode
                  ? parseInt(pedigree.breedCode)
                  : null;
                const coatColorCode = pedigree.coatColorCode
                  ? parseInt(pedigree.coatColorCode)
                  : null;
                const gender = pedigree.gender
                  ? parseInt(pedigree.gender)
                  : null;
                const brotherCount = pedigree.brotherCount
                  ? parseInt(pedigree.brotherCount)
                  : null;
                const sisterCount = pedigree.sisterCount
                  ? parseInt(pedigree.sisterCount)
                  : null;

                await prisma.pedigree.upsert({
                  where: { pedigreeId: pedigree.pedigreeId.toString() },
                  update: {
                    title: pedigree.title || null,
                    catName: pedigree.catName || '',
                    catName2: pedigree.catName2 || null,
                    breedCode,
                    gender,
                    eyeColor: pedigree.eyeColor || null,
                    coatColorCode,
                    birthDate,
                    registrationDate,
                    breederName: pedigree.breederName || null,
                    ownerName: pedigree.ownerName || null,
                    brotherCount,
                    sisterCount,
                    notes: pedigree.notes || null,
                    notes2: pedigree.notes2 || null,
                    otherNo: pedigree.otherNo || null,
                    oldCode: pedigree.oldCode || null,
                    // Father information - CSVã®æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ãƒãƒƒãƒ”ãƒ³ã‚°
                    fatherTitle: pedigree.fatherTitle || null,
                    fatherName: pedigree.fatherName || null, // FatherName -> fatherName
                    fatherCatName2: pedigree.fatherCatName2 || null, // FatherCatName2 -> fatherCatName2
                    fatherCoatColor: pedigree.fatherCoatColor || null,
                    fatherEyeColor: pedigree.fatherEyeColor || null,
                    fatherJCU: pedigree.fatherJCU || null,
                    fatherOtherCode: pedigree.fatherOtherCode || null,
                    // Mother information - CSVã®æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ãƒãƒƒãƒ”ãƒ³ã‚°
                    motherTitle: pedigree.motherTitle || null,
                    motherName: pedigree.motherCatName || null, // MotherCatName -> motherName
                    motherCatName2: pedigree.motherCatName2 || null, // MotherCatName2 -> motherCatName2
                    motherCoatColor: pedigree.motherCoatColor || null,
                    motherEyeColor: pedigree.motherEyeColor || null,
                    motherJCU: pedigree.motherJCU || null,
                    motherOtherCode: pedigree.motherOtherCode || null,
                    // Grandparent information - è‰²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
                    ffTitle: pedigree.ffTitle || null,
                    ffCatName: pedigree.ffCatName || null,
                    ffCatColor: pedigree.ffCatColor || null,
                    ffJCU: pedigree.ffJCU || null,
                    fmTitle: pedigree.fmTitle || null,
                    fmCatName: pedigree.fmCatName || null,
                    fmCatColor: pedigree.fmCatColor || null,
                    fmJCU: pedigree.fmJCU || null,
                    mfTitle: pedigree.mfTitle || null,
                    mfCatName: pedigree.mfCatName || null,
                    mfCatColor: pedigree.mfCatColor || null,
                    mfJCU: pedigree.mfJCU || null,
                    mmTitle: pedigree.mmTitle || null,
                    mmCatName: pedigree.mmCatName || null,
                    mmCatColor: pedigree.mmCatColor || null,
                    mmJCU: pedigree.mmJCU || null,
                    // Great-grandparent information - è‰²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
                    fffTitle: pedigree.fffTitle || null,
                    fffCatName: pedigree.fffCatName || null,
                    fffCatColor: pedigree.fffCatColor || null,
                    fffJCU: pedigree.fffJCU || null,
                    ffmTitle: pedigree.ffmTitle || null,
                    ffmCatName: pedigree.ffmCatName || null,
                    ffmCatColor: pedigree.ffmCatColor || null,
                    ffmJCU: pedigree.ffmJCU || null,
                    fmfTitle: pedigree.fmfTitle || null,
                    fmfCatName: pedigree.fmfCatName || null,
                    fmfCatColor: pedigree.fmfCatColor || null,
                    fmfJCU: pedigree.fmfJCU || null,
                    fmmTitle: pedigree.fmmTitle || null,
                    fmmCatName: pedigree.fmmCatName || null,
                    fmmCatColor: pedigree.fmmCatColor || null,
                    fmmJCU: pedigree.fmmJCU || null,
                    mffTitle: pedigree.mffTitle || null,
                    mffCatName: pedigree.mffCatName || null,
                    mffCatColor: pedigree.mffCatColor || null,
                    mffJCU: pedigree.mffJCU || null,
                    mfmTitle: pedigree.mfmTitle || null,
                    mfmCatName: pedigree.mfmCatName || null,
                    mfmCatColor: pedigree.mfmCatColor || null,
                    mfmJCU: pedigree.mfmJCU || null,
                    mmfTitle: pedigree.mmfTitle || null,
                    mmfCatName: pedigree.mmfCatName || null,
                    mmfCatColor: pedigree.mmfCatColor || null,
                    mmfJCU: pedigree.mmfJCU || null,
                    mmmTitle: pedigree.mmmTitle || null,
                    mmmCatName: pedigree.mmmCatName || null,
                    mmmCatColor: pedigree.mmmCatColor || null,
                    mmmJCU: pedigree.mmmJCU || null,
                  },
                  create: {
                    pedigreeId: pedigree.pedigreeId.toString(),
                    title: pedigree.title || null,
                    catName: pedigree.catName || '',
                    catName2: pedigree.catName2 || null,
                    breedCode,
                    gender,
                    eyeColor: pedigree.eyeColor || null,
                    coatColorCode,
                    birthDate,
                    registrationDate,
                    breederName: pedigree.breederName || null,
                    ownerName: pedigree.ownerName || null,
                    brotherCount,
                    sisterCount,
                    notes: pedigree.notes || null,
                    notes2: pedigree.notes2 || null,
                    otherNo: pedigree.otherNo || null,
                    oldCode: pedigree.oldCode || null,
                    // Father information - CSVã®æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ãƒãƒƒãƒ”ãƒ³ã‚°
                    fatherTitle: pedigree.fatherTitle || null,
                    fatherName: pedigree.fatherName || null, // FatherName -> fatherName
                    fatherCatName2: pedigree.fatherCatName2 || null, // FatherCatName2 -> fatherCatName2
                    fatherCoatColor: pedigree.fatherCoatColor || null,
                    fatherEyeColor: pedigree.fatherEyeColor || null,
                    fatherJCU: pedigree.fatherJCU || null,
                    fatherOtherCode: pedigree.fatherOtherCode || null,
                    // Mother information - CSVã®æ­£ç¢ºãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ãƒãƒƒãƒ”ãƒ³ã‚°
                    motherTitle: pedigree.motherTitle || null,
                    motherName: pedigree.motherCatName || null, // MotherCatName -> motherName
                    motherCatName2: pedigree.motherCatName2 || null, // MotherCatName2 -> motherCatName2
                    motherCoatColor: pedigree.motherCoatColor || null,
                    motherEyeColor: pedigree.motherEyeColor || null,
                    motherJCU: pedigree.motherJCU || null,
                    motherOtherCode: pedigree.motherOtherCode || null,
                    // Grandparent information - è‰²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
                    ffTitle: pedigree.ffTitle || null,
                    ffCatName: pedigree.ffCatName || null,
                    ffCatColor: pedigree.ffCatColor || null,
                    ffJCU: pedigree.ffJCU || null,
                    fmTitle: pedigree.fmTitle || null,
                    fmCatName: pedigree.fmCatName || null,
                    fmCatColor: pedigree.fmCatColor || null,
                    fmJCU: pedigree.fmJCU || null,
                    mfTitle: pedigree.mfTitle || null,
                    mfCatName: pedigree.mfCatName || null,
                    mfCatColor: pedigree.mfCatColor || null,
                    mfJCU: pedigree.mfJCU || null,
                    mmTitle: pedigree.mmTitle || null,
                    mmCatName: pedigree.mmCatName || null,
                    mmCatColor: pedigree.mmCatColor || null,
                    mmJCU: pedigree.mmJCU || null,
                    // Great-grandparent information - è‰²ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ 
                    fffTitle: pedigree.fffTitle || null,
                    fffCatName: pedigree.fffCatName || null,
                    fffCatColor: pedigree.fffCatColor || null,
                    fffJCU: pedigree.fffJCU || null,
                    ffmTitle: pedigree.ffmTitle || null,
                    ffmCatName: pedigree.ffmCatName || null,
                    ffmCatColor: pedigree.ffmCatColor || null,
                    ffmJCU: pedigree.ffmJCU || null,
                    fmfTitle: pedigree.fmfTitle || null,
                    fmfCatName: pedigree.fmfCatName || null,
                    fmfCatColor: pedigree.fmfCatColor || null,
                    fmfJCU: pedigree.fmfJCU || null,
                    fmmTitle: pedigree.fmmTitle || null,
                    fmmCatName: pedigree.fmmCatName || null,
                    fmmCatColor: pedigree.fmmCatColor || null,
                    fmmJCU: pedigree.fmmJCU || null,
                    mffTitle: pedigree.mffTitle || null,
                    mffCatName: pedigree.mffCatName || null,
                    mffCatColor: pedigree.mffCatColor || null,
                    mffJCU: pedigree.mffJCU || null,
                    mfmTitle: pedigree.mfmTitle || null,
                    mfmCatName: pedigree.mfmCatName || null,
                    mfmCatColor: pedigree.mfmCatColor || null,
                    mfmJCU: pedigree.mfmJCU || null,
                    mmfTitle: pedigree.mmfTitle || null,
                    mmfCatName: pedigree.mmfCatName || null,
                    mmfJCU: pedigree.mmfJCU || null,
                    mmmTitle: pedigree.mmmTitle || null,
                    mmmCatName: pedigree.mmmCatName || null,
                    mmmJCU: pedigree.mmmJCU || null,
                  },
                });
              } catch (pedigreeError) {
                console.warn(
                  `âš ï¸ è¡€çµ±æ›¸ ${pedigree.pedigreeId} ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼:`,
                  pedigreeError,
                );
              }
            }
          }

          console.log(
            `âœ… ${pedigrees.length}ä»¶ã®è¡€çµ±æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸ`,
          );
          resolve();
        } catch (error) {
          reject(error);
        }
      })
      .on('error', reject);
  });
}

// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°: æ—¥ä»˜è§£æ
function parseDate(dateString: string): Date | null {
  if (!dateString || dateString.trim() === '') return null;

  try {
    // YYYY.MM.DDå½¢å¼ã«å¯¾å¿œ
    const cleanedDate = dateString.replace(/\./g, '-');
    const date = new Date(cleanedDate);
    return isNaN(date.getTime()) ? null : date;
  } catch {
    return null;
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œéƒ¨åˆ†
if (require.main === module) {
  const args = process.argv.slice(2);
  const csvFileName = args[0];
  const skipBreeds = args.includes('--skip-breeds');
  const skipCoatColors = args.includes('--skip-colors');
  const skipPedigrees = args.includes('--skip-pedigrees');
  const batchSizeArg = args.find(arg => arg.startsWith('--batch-size='));
  const batchSize = batchSizeArg ? parseInt(batchSizeArg.split('=')[1]) : 100;

  console.log('ğŸ“‹ ã‚¤ãƒ³ãƒãƒ¼ãƒˆè¨­å®š:');
  console.log(`   ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«: ${csvFileName || 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'}`);
  console.log(`   ğŸ± çŒ«ç¨®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${skipBreeds ? 'ã‚¹ã‚­ãƒƒãƒ—' : 'å®Ÿè¡Œ'}`);
  console.log(`   ğŸ¨ æ¯›è‰²ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${skipCoatColors ? 'ã‚¹ã‚­ãƒƒãƒ—' : 'å®Ÿè¡Œ'}`);
  console.log(`   ğŸ“œ è¡€çµ±æ›¸ã‚¤ãƒ³ãƒãƒ¼ãƒˆ: ${skipPedigrees ? 'ã‚¹ã‚­ãƒƒãƒ—' : 'å®Ÿè¡Œ'}`);
  console.log(`   ğŸ“¦ ãƒãƒƒãƒã‚µã‚¤ã‚º: ${batchSize}`);

  importNewStructureCsvData(csvFileName, {
    skipBreeds,
    skipCoatColors,
    skipPedigrees,
    batchSize,
  })
    .then(() => {
      console.log('ğŸ‰ æ–°ã—ã„CSVæ§‹é€ ã§ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
      process.exit(0);
    })
    .catch(error => {
      console.error('ğŸ’¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
      process.exit(1);
    });
}

export { importNewStructureCsvData, importNewStructurePedigrees };
